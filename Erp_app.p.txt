import streamlit as st
import pandas as pd
import time
from datetime import datetime

# --- ×”×’×“×¨×•×ª ×¢×™×¦×•×‘ ×•××“×¢ ---
st.set_page_config(page_title="ERP Coach Pro", layout="centered")

# ×¢×™×¦×•×‘ ××•×ª×× ×œ××•×‘×™×™×œ (RTL) + ×”×“×’×©×ª ×”×ª×¡×¨×™×˜
st.markdown("""
    <style>
    body {direction: rtl; text-align: right; font-family: -apple-system, BlinkMacSystemFont, sans-serif;}
    .stTextInput, .stTextArea, .stSelectbox, .stSlider {direction: rtl;}
    div.stButton > button:first-child {background-color: #007AFF; color: white; border-radius: 12px; height: 50px; font-size: 18px;}
    
    /* ×¢×™×¦×•×‘ ×‘×•×œ×˜ ×œ×ª×¡×¨×™×˜ ×‘×–××Ÿ ×—×©×™×¤×” */
    .exposure-script {
        background-color: #fff9c4; /* ×¦×”×•×‘ ×‘×”×™×¨ */
        color: #333;
        padding: 25px;
        border-radius: 10px;
        border-right: 8px solid #fbc02d;
        font-size: 20px;
        line-height: 1.6;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .feedback-box {
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        font-size: 14px;
    }
    .feedback-error { background-color: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
    .feedback-success { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
    
    </style>
    """, unsafe_allow_html=True)

# --- × ×™×”×•×œ ×–×™×›×¨×•×Ÿ ---
if 'scripts' not in st.session_state: st.session_state.scripts = []
if 'logs' not in st.session_state: st.session_state.logs = []

# --- ××œ×’×•×¨×™×ª× ×‘×§×¨×ª ××™×›×•×ª ×œ-ERP ---
def analyze_script_quality(text):
    warnings = []
    tips = []
    
    # ×‘×“×™×§×ª ××™×œ×•×ª ×”×¨×’×¢×” (Reassurance) - ××¡×•×¨!
    forbidden_words = ["××‘×œ", "×œ×¤×—×•×ª", "×™×”×™×” ×‘×¡×“×¨", "×¡×š ×”×›×œ", "×¨×§ ××—×©×‘×”", "×œ× ×‘×××ª"]
    for word in forbidden_words:
        if word in text:
            warnings.append(f"âš ï¸ ×–×•×”×ª×” ×”××™×œ×” **'{word}'**. ×‘-ERP ×× ×—× ×• × ×× ×¢×™× ×××™×œ×•×ª ×‘×™×˜×•×œ ××• ×”×¨×’×¢×”. ××—×§ ××•×ª×”.")

    # ×‘×“×™×§×ª ××™×œ×•×ª ××™-×•×“××•×ª (Uncertainty) - ×—×•×‘×”!
    required_words = ["××•×œ×™", "×™×›×•×œ ×œ×”×™×•×ª", "×™×ª×›×Ÿ", "×œ× ××“×¢", "×¡×™×›×•×™", "×¡×¤×§"]
    if not any(word in text for word in required_words):
        warnings.append("âš ï¸ ×”×ª×¡×¨×™×˜ ×—×¡×¨ ××¨×›×™×‘ ×©×œ **×—×•×¡×¨ ×•×“××•×ª**. ×”×•×¡×£ ××™×œ×™× ×›××•: '××•×œ×™', '×™×›×•×œ ×œ×”×™×•×ª', '×™×™×ª×›×Ÿ ×©×–×” × ×›×•×Ÿ'.")

    # ××©×•×‘ ×—×™×•×‘×™
    if not warnings:
        tips.append("âœ… ×”×ª×¡×¨×™×˜ ×× ×•×¡×— ×”×™×˜×‘: ×”×•× ××ª×¢××ª ×¢× ×”×¤×—×“ ×œ×œ× ×”×¨×’×¢×”.")
    
    return warnings, tips

# --- ×ª×¤×¨×™×˜ ×¨××©×™ ---
st.title("ğŸ›¡ï¸ ERP Coach Pro")
st.caption("××¢×¨×›×ª ×—×›××” ×œ× ×™×”×•×œ ×—×©×™×¤×” ×•×× ×™×¢×ª ×ª×’×•×‘×”")

mode = st.selectbox("×‘×—×¨ ××¦×‘ ×¢×‘×•×“×”:", ["ğŸ“ ×™×¦×™×¨×ª ×ª×¡×¨×™×˜ ×—×©×™×¤×”", "â±ï¸ ×—×“×¨ ×—×©×™×¤×” (×‘×–××Ÿ ×××ª)", "ğŸ“Š ×™×•××Ÿ ××¢×§×‘"])

# --- ××¦×‘ 1: ×™×¦×™×¨×ª ×ª×¡×¨×™×˜ + ×× ×•×¢ ×”××œ×¦×•×ª ---
if mode == "ğŸ“ ×™×¦×™×¨×ª ×ª×¡×¨×™×˜ ×—×©×™×¤×”":
    st.subheader("×‘× ×™×™×ª ×ª×¡×¨×™×˜ ×—×“×©")
    
    with st.form("new_script"):
        title = st.text_input("×©× ×”×ª×¡×¨×™×˜ (×œ××©×œ: '×”×•×“×¢×•×ª ×‘×•×•××˜×¡××¤')")
        
        st.markdown("---")
        st.markdown("### 1. ×›×ª×™×‘×ª ×”×ª×¡×¨×™×˜ ×”×’×•×œ××™")
        st.info("×›×ª×•×‘ ×›××Ÿ ××ª ×”×ª×¨×—×™×© ×”××¤×—×™×“ ×‘×™×•×ª×¨. ×–×›×•×¨: ××œ ×ª× ×¡×” ×œ×¤×ª×•×¨ ××•×ª×•.")
        
        full_text = st.text_area("×”×ª×¡×¨×™×˜ ×”××œ× (××” ×”×˜×¨×™×’×¨ ×•××” ×× ×™ ××¤×—×“ ×©×§×•×¨×”?):", height=150, 
                                 placeholder="×œ××©×œ: ×”×™× ×œ× ×¢×•× ×” ×œ×™ ×›×‘×¨ ×©×¢×ª×™×™×. ×™×›×•×œ ×œ×”×™×•×ª ×©×”×™× ×‘×“×™×•×§ ×›×•×ª×‘×ª ×œ×™ ×”×•×“×¢×ª ×¤×¨×™×“×”...")
        
        prevention = st.text_input("×× ×™×¢×ª ×ª×’×•×‘×” (××” ××¡×•×¨ ×œ×™ ×œ×¢×©×•×ª?):", value="×œ× ×œ×‘×“×•×§, ×œ× ×œ×©××•×œ, ×œ× ×œ× ×ª×— ×‘×¨××©.")
        
        # --- ×‘×“×™×§×” ×‘×–××Ÿ ×××ª ---
        warnings, tips = analyze_script_quality(full_text)
        
        if full_text:
            st.markdown("---")
            st.markdown("### ğŸ¤– × ×™×ª×•×— ×§×œ×™× ×™ ××•×˜×•××˜×™ (ERP Check)")
            for w in warnings:
                st.markdown(f'<div class="feedback-box feedback-error">{w}</div>', unsafe_allow_html=True)
            for t in tips:
                st.markdown(f'<div class="feedback-box feedback-success">{t}</div>', unsafe_allow_html=True)
        
        st.markdown("---")
        submitted = st.form_submit_button("×©××•×¨ ×ª×¡×¨×™×˜ ×œ×××’×¨")
        
        if submitted:
            if title and full_text:
                if warnings:
                    st.error("×”×ª×¡×¨×™×˜ ××›×™×œ ×‘×¢×™×•×ª (×¨××” ×œ××¢×œ×”). ××•××œ×¥ ×œ×ª×§×Ÿ ×œ×¤× ×™ ×”×©××™×¨×”, ××š × ×©××¨ ×‘×›×œ ×–××ª.")
                
                st.session_state.scripts.append({
                    "title": title, 
                    "content": full_text, 
                    "prevention": prevention
                })
                st.success("×”×ª×¡×¨×™×˜ × ×©××¨ ×‘×”×¦×œ×—×”.")
            else:
                st.error("×™×© ×œ××œ× ×›×•×ª×¨×ª ×•×ª×•×›×Ÿ.")

# --- ××¦×‘ 2: ×—×“×¨ ×—×©×™×¤×” (×¢× ×ª×¦×•×’×” ××œ××”) ---
elif mode == "â±ï¸ ×—×“×¨ ×—×©×™×¤×” (×‘×–××Ÿ ×××ª)":
    if not st.session_state.scripts:
        st.warning("××™×Ÿ ×ª×¡×¨×™×˜×™×. ×¢×‘×•×¨ ×œ×œ×©×•× ×™×ª ×”×™×¦×™×¨×”.")
    else:
        script = st.selectbox("×‘×—×¨ ×ª×¡×¨×™×˜ ×œ×ª×¨×’×•×œ:", st.session_state.scripts, format_func=lambda x: x['title'])
        
        st.markdown("### ×©×œ×‘ 1: ×œ×¤× ×™ ×”×—×©×™×¤×”")
        predicted_distress = st.slider("×¢×“ ×›××” ××ª×” ×—×•×©×‘ ×©×–×” ×™×”×™×” × ×•×¨×? (0-10)", 0, 10, 8)
        
        st.markdown("---")
        st.markdown("### ×”×ª×¡×¨×™×˜ ×©×œ×š:")
        # ×›××Ÿ ×”×©×™× ×•×™ - ×”×¦×’×ª ×”×ª×¡×¨×™×˜ ×‘×¦×•×¨×” ×‘×•×œ×˜×ª ×•×§×‘×•×¢×”
        st.markdown(f"<div class='exposure-script'>{script['content']}</div>", unsafe_allow_html=True)
        
        st.error(f"ğŸ›‘ **×—×•×§×™ ×× ×™×¢×ª ×ª×’×•×‘×”:** {script['prevention']}")
        
        exposure_time = st.selectbox("×–××Ÿ ×—×©×™×¤×” ×‘×“×§×•×ª:", [5, 10, 15, 20])
        
        if st.button("×”×ª×—×œ ×˜×™×™××¨"):
            progress_bar = st.progress(0)
            status = st.empty()
            
            # ×˜×™×™××¨
            total_seconds = exposure_time * 60
            for i in range(total_seconds):
                percent = (i + 1) / total_seconds
                progress_bar.progress(percent)
                status.info(f"â³ ×–××Ÿ × ×•×ª×¨: {total_seconds - i} ×©× ×™×•×ª. ×”×™×©××¨ ×¢× ×”×˜×§×¡×˜ ×œ××¢×œ×”.")
                time.sleep(1)
            
            status.success("×”×—×©×™×¤×” ×”×¡×ª×™×™××”!")
            
            # ×©××™×¨×ª × ×ª×•× ×™× ×œ×–×™×›×¨×•×Ÿ ×–×× ×™ ×›×“×™ ×œ××¤×©×¨ ×“×™×•×•×—
            st.session_state.current_exposure = {
                "script": script['title'], 
                "predicted": predicted_distress
            }

        # ×“×™×•×•×— ×œ××—×¨ ×—×©×™×¤×”
        if 'current_exposure' in st.session_state:
            st.markdown("---")
            st.markdown("### ×©×œ×‘ 2: ××—×¨×™ ×”×—×©×™×¤×”")
            actual_distress = st.slider("×‘×¤×•×¢×œ - ×›××” ××¦×•×§×” ×”×¨×’×©×ª? (0-10)", 0, 10, 5, key="actual")
            
            if st.button("×¡×™×™× ×•×©××•×¨ ×‘×™×•××Ÿ"):
                # ×—×™×©×•×‘ ×œ××™×“×”
                gap = st.session_state.current_exposure['predicted'] - actual_distress
                conclusion = "×œ× ×”×™×™×ª×” ×”×¤×ª×¢×”"
                if gap > 0: conclusion = f"âœ¨ ×œ××™×“×” ××¢×›×‘×ª ×—×™×•×‘×™×ª! (×¤×¢×¨ ×©×œ {gap} × ×§×•×“×•×ª)"
                elif gap < 0: conclusion = "âš ï¸ ×”×—×¨×“×” ×”×™×™×ª×” ×’×‘×•×”×” ××”××¦×•×¤×”"
                
                st.session_state.logs.append({
                    "×ª××¨×™×š": datetime.now().strftime("%d/%m %H:%M"),
                    "×ª×¡×¨×™×˜": st.session_state.current_exposure['script'],
                    "×¦×¤×™ (0-10)": st.session_state.current_exposure['predicted'],
                    "×‘×¤×•×¢×œ (0-10)": actual_distress,
                    "××¡×§× ×”": conclusion
                })
                st.success("×”×ª×¨×’×•×œ × ×©××¨ ×‘×™×•××Ÿ.")
                del st.session_state.current_exposure

# --- ××¦×‘ 3: ×™×•××Ÿ ---
elif mode == "ğŸ“Š ×™×•××Ÿ ××¢×§×‘":
    if st.session_state.logs:
        df = pd.DataFrame(st.session_state.logs)
        st.table(df)
    else:
        st.info("×¢×“×™×™×Ÿ ××™×Ÿ × ×ª×•× ×™×. ×‘×¦×¢ ×—×©×™×¤×” ×¨××©×•× ×”.")

